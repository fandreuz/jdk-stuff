compile() {
    git stash
    rm -rf build/feature

    FEATURES=""
    for feature in $1; do
        FEATURES+=" --enable-jvm-feature-$feature"
    done
    sh configure --with-build-user=fandreuz \
                 --with-conf-name=feature \
                 --with-toolchain-type=clang \
                 --with-jvm-variants=custom \
                 $FEATURES

    for i in {1..10}; do
        make -j clean CONF_NAME=feature
        /usr/bin/time --append --output output -f "%S %U" make -j hotspot CONF_NAME=feature
    done

    java -cp src/utils/PrecompiledHeaders PrecompiledHeaders 400 build/feature
    for i in {1..10}; do
        make -j clean CONF_NAME=feature
        /usr/bin/time --append --output output -f "%S %U" make -j hotspot CONF_NAME=feature
    done
}

set -euox

rm -f output
git checkout baseline

while IFS= read -r line; do
    echo "------------" >> output
    echo "$line" >> output

    if [[ "$line" == //* ]]; then
        continue
    fi

    compile "$line"    
done
