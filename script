compile() {
    git stash
    rm -rf build/feature

    FEATURES=""
    for feature in $1; do
        FEATURES+=" --enable-jvm-feature-$feature"
    done
    sh configure --with-build-user=fandreuz \
                 --with-conf-name=feature \
                 --with-toolchain-type=clang \
                 --with-jvm-variants=custom \
                 $FEATURES

    for i in {1..3}; do
        make -j clean CONF_NAME=feature
        /usr/bin/time --append --output compilation_times -f "%S %U" make -j hotspot CONF_NAME=feature
    done

    java -cp src/utils/PrecompiledHeaders PrecompiledHeaders 400 build/feature
    for i in {1..3}; do
        make -j clean CONF_NAME=feature
        /usr/bin/time --append --output compilation_times -f "%S %U" make -j hotspot CONF_NAME=feature
    done
    
    features_underscore="${1// /_}"
    out_file="precompiled_$features_underscore.hpp"
    echo "#if $features_underscore" >> "$out_file"
    { git diff --unified=0 --no-prefix | grep '^+' | grep -v '^+++' | cut -c 2-; } >> "$out_file" || true
}

set -euox

rm -f compilation_times
rm -f precompiled_*.hpp

while IFS= read -r line; do
    echo "------------" >> compilation_times
    echo "$line" >> compilation_times

    if [[ "$line" == //* ]]; then
        continue
    fi

    compile "$line"    
done < features
