set -eux

OUTPUT=time.txt

measure() {
    for i in {1..3}; do
    make -j CONF_NAME=$1 clean
    /usr/bin/time --append --output "$OUTPUT" -f "%S %U" make -j CONF_NAME=$1 hotspot
    done
}

benchmark_step() {
    git checkout $1 -- src/hotspot/share/precompiled/precompiled.hpp

    for compiler in gcc clang; do
    for dbg in prod fd; do
    echo $1 $compiler $dbg >> "$OUTPUT"
    measure $compiler-$dbg
    done
    done
}

sh configure --with-build-user=fandreuz \
             --with-toolchain-type=clang \
             --with-conf-name=clang-prod

sh configure --with-build-user=fandreuz \
             --with-toolchain-type=clang \
             --with-conf-name=clang-fd \
             --enable-debug

sh configure --with-build-user=fandreuz --with-conf-name=gcc-prod

sh configure --with-build-user=fandreuz --with-conf-name=gcc-fd \
                                        --enable-debug

rm -f "$OUTPUT"
git config --global --add safe.directory /jdk

benchmark_step master
benchmark_step 9e0cb7e8
benchmark_step fb260abe
